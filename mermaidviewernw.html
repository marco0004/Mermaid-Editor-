<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Mermaid Editor</title>
 <style>
  body {
   font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
   display: flex;
   flex-direction: column;
   height: 100vh;
   margin: 0;
   padding: 20px;
   background-color: #e9f2f8;
   color: #333;
   transition: padding 0.5s ease;
  }

  body.full-screen {
   padding: 0;
  }

  h1 {
   text-align: center;
   color: #004d66;
   margin-bottom: 2px;
   font-weight: 100;
   transition: opacity 0.5s ease;
   font-size: 24px;
  }
		
		.footer {
   text-align: center;
   color: #004d66;
   margin-bottom: 2px;
   font-weight: 100;
   transition: opacity 0.5s ease;
   font-size: 16px;
  }

  .controls {
   display: flex;
   justify-content: space-between;
   gap: 20px;
   margin-bottom: 10px;
   align-items: center;
   background: #fff;
   padding: 8px;
   border-radius: 12px;
   box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .controls .button-group {
   display: flex;
   gap: 10px;
   align-items: center;
  }

  .controls button, .controls select {
   padding: 8px 12px;
   border: none;
   border-radius: 6px;
   font-size: 14px;
   cursor: pointer;
   background-color: #007bff;
   color: white;
   font-weight: 600;
   transition: background-color 0.2s ease-in-out;
  }

  .controls button:hover {
   background-color: #0056b3;
  }

  .controls button.action-button {
   background-color: #28a745;
  }

  .controls button.action-button:hover {
   background-color: #218838;
  }

  .back-button {
   padding: 8px 12px;
   border: none;
   border-radius: 6px;
   font-size: 14px;
   cursor: pointer;
   background-color: #dc3545;
   color: white;
   font-weight: 600;
   transition: background-color 0.2s ease-in-out;
  }

  .back-button:hover {
   background-color: #c82333;
  }

  .container {
   display: flex;
   flex-grow: 1;
   gap: 20px;
   transition: flex-basis 0.5s ease;
  }

  .editor, .preview {
   border-radius: 12px;
   box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
   transition: flex-basis 0.5s ease;
  }

  .editor {
   flex-basis: 30%;
   display: flex;
   flex-direction: column;
   overflow: hidden;
   transition: flex-basis 0.5s ease, opacity 0.5s ease;
  }

  .hidden {
   display: none;
   opacity: 0;
   pointer-events: none;
   margin: 0;
   height: 0;
   overflow: hidden;
  }

  .preview {
   flex-basis: 70%;
   background-color: #ffffff;
   padding: 15px;
   overflow: auto;
   display: flex;
   align-items: center;
   justify-content: center;
   min-width: 200px;
   min-height: 200px;
   transition: flex-basis 0.5s ease, padding 0.5s ease;
  }

  .preview.full-screen {
   flex-basis: 100% !important;
   padding: 0;
   border-radius: 0;
   box-shadow: none;
  }

  /* --- MODIFICATION START --- */
  textarea {
   width: 100%;
   height: 100%;
   padding: 15px;
   box-sizing: border-box;
   border: none;
   outline: none;
   font-family: 'Fira Code', 'Courier New', monospace;
   font-size: 13px;
   resize: vertical;
   background-color: #f8f9fa;
   line-height: 1.6;
   color: #343a40;
   white-space: nowrap;/* Prevents line wrapping */
   overflow-x: auto;   /* Adds horizontal scrollbar */
  }
  /* --- MODIFICATION END --- */

  .mermaid-container {
   width: 100%;
   height: 100%;
   display: flex;
   align-items: center;
   justify-content: center;
  }

  .error-message {
   color: #dc3545;
   font-weight: 500;
   text-align: center;
   padding: 20px;
  }

  #file-input {
   display: none;
  }

  .donate-button {
   display: inline-block;
   text-decoration: none;
  }
 </style>
</head>
<body>

 <h1>Mermaid Editor</h1>

 <div class="controls">
  <div class="button-group">
   <button id="save-code-button" class="action-button">Save Code</button>
   <button id="load-code-button" class="action-button">Load Code</button>
   <button id="save-button">Save as SVG</button>
   <button id="save-page-button">Save as Webpage</button>
   <button id="toggle-editor-button">Hide Editor</button>
  </div>
  <div class="button-group">
   <label for="mermaid-version-select">Mermaid Version:</label>
   <select id="mermaid-version-select">
				<option value="https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.min.js">v11.12.1</option>			
    <option value="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js">v10</option>
   </select>
   <button id="donate-button"><a href="https://www.paypal.com/donate/?business=4A9E9V4R5YBXY&no_recurring=1&item_name=Enjoying+the+tool?+Consider+supporting+it%2C+buying+me+a+coffee%21&currency_code=USD" target="_blank" class="donate-button action-button">Donate</a></button>
  </div>
 </div>

 <div class="container">
  <div class="editor">
   <textarea id="mermaid-code">graph TD
A[Start] --> B(Process)
B --> C{Decision}
C -- Yes --> D[Result 1]
C -- No --> E[Result 2]
</textarea>
   </div>
  <div class="preview">
   <div class="mermaid-container" id="mermaid-preview-container"></div>
   <button id="back-to-editor-button" class="back-button hidden">Back</button>
  </div>
 </div>

 <input type="file" id="file-input" accept=".mmd, .txt">

 <div class="footer">
  Learn more about Mermaid syntax: <a href="https://mermaid.js.org/intro/syntax-reference.html" target="_blank">Mermaid Syntax Reference</a>
 </div>

 <script>
  const mermaidVersionSelect = document.getElementById('mermaid-version-select');
  const mermaidCode = document.getElementById('mermaid-code');
  const mermaidPreviewContainer = document.getElementById('mermaid-preview-container');
  const saveButton = document.getElementById('save-button');
  const saveCodeButton = document.getElementById('save-code-button');
  const loadCodeButton = document.getElementById('load-code-button');
  const savePageButton = document.getElementById('save-page-button');
  const fileInput = document.getElementById('file-input');
  const toggleEditorButton = document.getElementById('toggle-editor-button');
  const editorPanel = document.querySelector('.editor');
  const previewPanel = document.querySelector('.preview');
  const h1 = document.querySelector('h1');
  const controls = document.querySelector('.controls');
  const footer = document.querySelector('.footer');
  const backButton = document.getElementById('back-to-editor-button');

  const loadMermaidScript = (versionUrl) => {
   const existingScript = document.querySelector('script[src*="mermaid.min.js"]');
   if (existingScript) {
    existingScript.remove();
   }

   const script = document.createElement('script');
   script.src = versionUrl;
   script.onload = () => {
    console.log(`Mermaid.js version loaded: ${versionUrl}`);
    renderMermaid();
   };
   document.head.appendChild(script);
  };

  const renderMermaid = async () => {
   const code = mermaidCode.value;

   try {
    if (window.mermaid) {
     mermaid.initialize({
      startOnLoad: false,
      theme: 'default',
      securityLevel: 'loose',
     });
     const { svg } = await mermaid.render('mermaid-preview-id', code);
     mermaidPreviewContainer.innerHTML = svg;
    } else {
     mermaidPreviewContainer.innerHTML = `<div class="error-message">Mermaid library is not loaded. Please select a version.</div>`;
    }
   } catch (error) {
    mermaidPreviewContainer.innerHTML = `<div class="error-message">Error: Invalid Mermaid code.<br>${error.message}</div>`;
   }
  };

  const fullyInlineStyles = (element) => {
   if (!element) return;
   const computed = getComputedStyle(element);
   const inlineStyle = element.style;
   for (let i = 0; i < computed.length; i++) {
    const prop = computed[i];
    const value = computed.getPropertyValue(prop);
    inlineStyle.setProperty(prop, value, computed.getPropertyPriority(prop));
   }
   Array.from(element.children).forEach(fullyInlineStyles);
  };

  const saveSvg = () => {
   const svgElement = mermaidPreviewContainer.querySelector('svg');
   if (svgElement) {
    const clonedSvg = svgElement.cloneNode(true);
    fullyInlineStyles(clonedSvg);
    const svgData = new XMLSerializer().serializeToString(clonedSvg);
    const blob = new Blob([svgData], { type: 'image/svg+xml' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'mermaid-diagram.svg';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
   }
  };

  const saveToFile = () => {
   const code = mermaidCode.value;
   const blob = new Blob([code], { type: 'text/plain' });
   const url = URL.createObjectURL(blob);
   const link = document.createElement('a');
   link.href = url;
   link.download = 'mermaid-code.mmd';
   document.body.appendChild(link);
   link.click();
   document.body.removeChild(link);
   URL.revokeObjectURL(url);
  
   // Save the current code to localStorage
   localStorage.setItem('lastMermaidCode', code);
  };

  const loadFromFile = () => {
   fileInput.click();
  };

  const savePageAsHtml = () => {
   const originalHtml = document.documentElement.outerHTML;
   const mermaidCode = document.getElementById('mermaid-code').value;
   let newHtml = originalHtml;
   const textareaStart = newHtml.indexOf('<textarea id="mermaid-code">');
   const textareaEnd = newHtml.indexOf('</textarea>');
   if (textareaStart !== -1 && textareaEnd !== -1) {
    const startOfContent = textareaStart + '<textarea id="mermaid-code">'.length;
    const substringToReplace = newHtml.substring(startOfContent, textareaEnd);
    newHtml = newHtml.replace(substringToReplace, mermaidCode);
   }
   const blob = new Blob([newHtml], { type: 'text/html' });
   const url = URL.createObjectURL(blob);
   const link = document.createElement('a');
   link.href = url;
   link.download = 'mermaid-editor.html';
   document.body.appendChild(link);
   link.click();
   document.body.removeChild(link);
   URL.revokeObjectURL(url);

   // Save the current code to localStorage when saving the page
   localStorage.setItem('lastMermaidCode', mermaidCode);
  };

  fileInput.addEventListener('change', (event) => {
   const file = event.target.files[0];
   if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
     const loadedCode = e.target.result;
     mermaidCode.value = loadedCode;
     renderMermaid();
     // Also save loaded code to localStorage to remember it
     localStorage.setItem('lastMermaidCode', loadedCode);
    };
    reader.readAsText(file);
   }
  });

  const toggleVisibility = () => {
   const isHidden = !editorPanel.classList.contains('hidden');
   editorPanel.classList.toggle('hidden', isHidden);
   h1.classList.toggle('hidden', isHidden);
   controls.classList.toggle('hidden', isHidden);
   footer.classList.toggle('hidden', isHidden);
   backButton.classList.toggle('hidden', !isHidden);
   document.body.classList.toggle('full-screen', isHidden);
   previewPanel.classList.toggle('full-screen', isHidden);
   toggleEditorButton.textContent = isHidden ? 'Show Editor' : 'Hide Editor';
  };

  toggleEditorButton.addEventListener('click', toggleVisibility);
  backButton.addEventListener('click', toggleVisibility);

  mermaidCode.addEventListener('input', () => {
   renderMermaid();
   // Save code to localStorage on every input
   localStorage.setItem('lastMermaidCode', mermaidCode.value);
  });

  saveButton.addEventListener('click', saveSvg);
  saveCodeButton.addEventListener('click', saveToFile);
  loadCodeButton.addEventListener('click', loadFromFile);
  savePageButton.addEventListener('click', savePageAsHtml);
  mermaidVersionSelect.addEventListener('change', (event) => {
   loadMermaidScript(event.target.value);
  });

  document.addEventListener('DOMContentLoaded', () => {
   // Check if there is saved code in localStorage and load it
   const lastCode = localStorage.getItem('lastMermaidCode');
   if (lastCode) {
    mermaidCode.value = lastCode;
   }
   loadMermaidScript(mermaidVersionSelect.value);
  });
 </script>
</body>
</html>